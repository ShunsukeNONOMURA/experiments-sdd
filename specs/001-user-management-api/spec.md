# Feature Specification: ユーザ管理API

**Feature Branch**: `001-user-management-api`  
**Created**: 2025-11-25  
**Status**: Draft  
**Input**: User description: "ユーザを管理するAPIを作成してください。ユーザを一覧するIFとユーザを一人追加削除するIFがそれぞれ必要です。"

## Clarifications

### Session 2025-11-25

- Q: ユーザ削除IFで削除データはどのように扱うか? → A: 論理削除（ステータス無効化）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 登録済みユーザを一覧表示できる (Priority: P1)

管理者はAPIを介して現在登録されている全ユーザの一覧を取得し、名前・メールアドレス・作成日時などのプロファイルを把握したい。

**Why this priority**: 一覧がないと管理状況を確認できないため、他の操作（追加・削除）の前提となる。API公開後に最初に利用されるユースケースでもある。

**Independent Test**: モックデータを用意して一覧取得IFにGETリクエストを送り、期待通りの件数とメタデータが返るかを確認するだけで完結に検証できる。

**Acceptance Scenarios**:

1. **Given** 最低1件以上のユーザが存在する, **When** 管理者クライアントが一覧IFを呼び出す, **Then** ユーザ配列と件数メタデータが返り、情報が完全である。
2. **Given** 0件のユーザしか存在しない, **When** 同じIFを呼び出す, **Then** 空配列と総件数0が返り、エラーにはならない。

---

### User Story 2 - 新規ユーザを登録できる (Priority: P2)

管理者は名前・メールアドレス・任意の役割情報を入力し、APIを通じて新規ユーザを1名追加したい。

**Why this priority**: 組織内のユーザを増やす主目的であり、一覧の次に頻度が高い操作。適切なバリデーションで重複登録を防止する必要がある。

**Independent Test**: 空のシステムに対しPOSTでユーザ情報を送信し、201レスポンスと作成内容を確認する自動テストで単体検証できる。

**Acceptance Scenarios**:

1. **Given** 入力必須項目（名前・メールアドレス・役割）が有効な形式で用意されている, **When** 追加IFに送信する, **Then** ユーザID付きで登録され、一覧に即時反映される。
2. **Given** 既存メールアドレスと重複する入力, **When** 同じIFに送信する, **Then** バリデーションエラー（400）と理由が返る。

---

### User Story 3 - 不要なユーザを削除できる (Priority: P3)

管理者は退職者や誤登録ユーザをAPIから指定IDで1名削除し、一覧から除外したい。

**Why this priority**: 操作頻度は追加より小さいが、セキュリティとライセンスコストの抑制に直結するため必要。

**Independent Test**: 既知のユーザIDをセットアップし、DELETEリクエストが204を返すか、再取得時に存在しないことを確認するテストで完結する。

**Acceptance Scenarios**:

1. **Given** 指定IDのユーザが存在する, **When** 削除IFを呼び出す, **Then** 204が返り、一覧結果から該当ユーザが除去される。
2. **Given** 指定IDのユーザが存在しない, **When** 同じIFを呼ぶ, **Then** 404が返り、何も変更されない。

---

### Edge Cases

- 登録済みユーザが非常に多い場合でもページング情報を指定しないリクエストに対してはデフォルトページサイズで応答し、タイムアウトを防ぐ必要がある。
- 追加IFで必須項目が欠落した場合は、どのフィールドが不足しているかを示したバリデーションエラーを返す。
- 削除IFに同時刻で同一IDが複数回投げられた際も、1回目以降は冪等に成功（204または404）する。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: APIは`ユーザ一覧IF`を提供し、名前・メールアドレス・役割・作成日時を含むユーザ集合と、総件数・ページサイズ・オフセットなどのメタデータを返さなければならない。デフォルトでは`status=active`のユーザのみ返すが、明示的なフィルタ指定でinactiveユーザも取得できる。
- **FR-002**: 一覧IFはページング用のクエリパラメータ（例: `page`, `limit`）を受け取り、指定がない場合は安全なデフォルト値で応答しなければならない。
- **FR-003**: APIは`ユーザ追加IF`を提供し、名前・メールアドレス・役割を必須項目として受け取り、バリデーションを通過した入力のみ新規作成しなければならない。
- **FR-004**: 追加IFはメールアドレス重複を検出した場合、409または400で重複理由を返し、データを保存してはならない。
- **FR-005**: APIは`ユーザ削除IF`を提供し、ユーザIDを指定して1名だけを論理削除（`status=inactive`などで無効化）し、該当ユーザが存在しない場合は404を返さなければならない。
- **FR-006**: 削除IFは冪等であり、同じIDへの繰り返しリクエストがあってもシステム状態を壊さず適切なステータスを返さなければならない。
- **FR-007**: すべてのIFは成功・失敗ともに標準化されたレスポンスフォーマット（コード、メッセージ、トレースID）を返し、同時に監査ログへ操作内容を記録しなければならない。

### Key Entities *(include if feature involves data)*

- **User**: 管理対象となる個人。属性として`userId`（一意識別子）、`name`、`email`、`role`、`status`（active/inactive）、`createdAt`、`updatedAt`を持ち、メールアドレスは一意である。`status`は論理削除状態を表す。
- **UserCollectionResponse**: 一覧IFの応答。`users`配列（Userの配列）、`totalCount`、`pageSize`、`page`、`hasNext`などのメタデータで構成される。

## Assumptions & Dependencies

- 当面は管理者ロールのみがAPIを実行し、認可や監査の仕組みは既存の共通基盤に依存する。
- ユーザ属性は氏名・メールアドレス・役割に限定され、追加属性が必要になった場合は別機能で拡張する。
- 永続化層とID採番は既存ユーザデータベース（単一リージョン）を利用し、マルチテナンシー要件は対象外とする。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザ一覧IFは、5,000件のユーザデータに対しても95パーセンタイルで500ms以内に応答する。
- **SC-002**: 追加IFは正しい入力に対し100%成功し、レスポンスに作成済みユーザIDを含めることで追跡可能になる。
- **SC-003**: 削除IFは存在しないID指定時に100%で404を返し、誤削除やサイレント失敗を起こさない。
- **SC-004**: リリース後1ヶ月以内に、ユーザの追加・削除作業が全てAPI経由で完結し、手動DB操作やサポート依頼が0件になる。
